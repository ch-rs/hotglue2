$.glue.text=function(){function n(t,e,n){if("string"!=typeof e){if(!e.toString)return"";e=e.toString()}if("string"!=typeof n){if(!n.toString)return"";n=n.toString()}for(var s=0;s+t.length<=n.length;)n.substring(s,s+t.length)==t?(n=n.substring(0,s)+e+n.substring(s+t.length),s+=e.length):s++;return n}return{get_fonts:function(t,e){for(var n=0;n<document.styleSheets.length;n++)for(var s=document.styleSheets[n],i=0;s.cssRules&&i<s.cssRules.length;i++){var l,a,o,r,c=s.cssRules[i];c.selectorText&&".glue-font"==c.selectorText.substr(0,10)&&-1!=(a=(l=c.cssText).indexOf("font-family:"))&&(a+=12,o=l.length-1,-1!=(r=l.indexOf("}",a))&&(o=r-1),-1!=(r=l.indexOf(";",a))&&r<o&&(o=r-1),t.push($.trim(l.substr(a,o-a+1))),".glue-font-woff"==c.selectorText.substr(0,15))&&e.push($.trim(l.substr(a,o-a+1)))}},insert_at_cursor:function(t,e){var n=(t=$(t).get(0)).selectionStart,s=t.selectionEnd;t.value=t.value.substring(0,n)+e+t.value.substring(s,t.value.length),t.selectionStart=n+e.length,t.selectionEnd=n+e.length},render_content:function(t,e){return t=n("$BASEURL$",$.glue.base_url,t),t=n("$baseurl$",$.glue.base_url,t),t=n("$GLUE$",n(",",".",$.glue.version),t),t=n("$glue$",n(",",".",$.glue.version),t),t=n("$OBJ$",e,t),t=n("$obj$",e,t),t=n("$PAGE$",$.glue.page,t),t=n("$page$",$.glue.page,t),t=n("$PAGENAME$",$.glue.page.split(".").slice(0,1),t),t=n("$pagename$",$.glue.page.split(".").slice(0,1),t),t="https:"==location.protocol?(t=n("$PROT$","https",t),n("$prot$","https",t)):(t=n("$PROT$","http",t),n("$prot$","http",t)),t=n("$REV$",$.glue.page.split(".").slice(1,2),t),t=n("$rev$",$.glue.page.split(".").slice(1,2),t),$.glue.conf.text.auto_br&&(t=n("\r\n","<br>",t),t=n("\n","<br>",t)),t},stop_editing:function(t){$(t).children(".glue-text-render").html($.glue.text.render_content($(t).children(".glue-text-input").val(),$(t).attr("id"))),$(t).removeClass("glue-text-editing"),$(t).children(".glue-text-render").find("a").bind("click",function(t){return!1}),$(t).children(".glue-text-render").find("a").attr("title","this link is disabled for editing"),$(t).children(".glue-text-render").find("a").each(function(){var t=$(this).attr("href");t&&"#"!=t.charAt(0)&&t.indexOf("://")<1&&$(this).attr("href",$.glue.base_url+t)}),$(t).children(".glue-text-input").css("display","none"),$(t).children(".glue-text-render").css("display","block"),$(t).children(".glue-text-input").text($(t).children(".glue-text-input").val()),$.glue.backend({method:"glue.update_object",name:$(t).attr("id"),content:$(t).children(".glue-text-input").val()})}}}(),$(".text").live("glue-register",function(t){$(this).children(".glue-text-input").bind("mousedown",function(t){"none"!=$(this).css("display")&&t.stopPropagation()}),$(this).children(".glue-text-input").bind("keydown",function(t){if("none"!=$(this).css("display"))return t.stopPropagation(),9==t.which?($.glue.text.insert_at_cursor($(this),String.fromCharCode(9)),t.preventDefault(),!1):t.shiftKey&&32==t.which?($.glue.text.insert_at_cursor($(this),String.fromCharCode(160)),t.preventDefault(),!1):27==t.which?($.glue.text.stop_editing($(this).parent()),t.preventDefault(),!1):void 0}),$(this).children(".glue-text-input").bind("keypress",function(t){"none"!=$(this).css("display")&&t.stopPropagation()}),$(this).children(".glue-text-input").bind("keyup",function(t){"none"!=$(this).css("display")&&t.stopPropagation()}),$(this).children(".glue-text-render").find("a").bind("click",function(t){return!1}),$(this).children(".glue-text-render").find("a").attr("title","this link is disabled for editing")}),$(".text").live("glue-deselect",function(t){$(this).hasClass("glue-text-editing")&&$.glue.text.stop_editing(this)}),$(".text.glue-selected").live("click",function(t){$(this).hasClass("glue-text-editing")||($(this).hasClass("glue-selected")&&$(".glue-selected").not(this).each(function(){$.glue.sel.deselect(this)}),$(this).children(".glue-text-input").css("display","block"),$(this).children(".glue-text-render").css("display","none"),$(this).addClass("glue-text-editing"),$(this).children(".glue-text-input").focus(),$(this).children(".glue-text-input").get(0).setSelectionRange&&$(this).children(".glue-text-input").get(0).setSelectionRange(0,0))}),$(document).ready(function(){var t=$('<img src="'+$.glue.base_url+'modules/text/text.png" alt="btn" title="add a new text object" width="32" height="32">'),s=($(t).bind("click",function(n){$.glue.backend({method:"glue.create_object",page:$.glue.page},function(t){var e=$('<div class="text resizable object" style="position: absolute;"><textarea class="glue-text-input" style="display: none; height: 100%; width: 100%;"></textarea><div class="glue-text-render" style="height: 100%; width: 100%;"></div></div>');$(e).attr("id",t.name),$.glue.conf.object.default_colors&&(t=Math.floor(Math.random()*$.glue.conf.object.default_colors.length),$(e).css("background-color",$.glue.conf.object.default_colors[t])),$("body").append(e),$(e).css("width",$(e).width()+"px"),$(e).css("height",$(e).height()+"px"),$(e).css("left",n.pageX-$(e).outerWidth()/2+"px"),$(e).css("top",n.pageY-$(e).outerHeight()/2+"px"),$.glue.object.register(e),$.glue.object.save(e)}),$.glue.menu.hide()}),$.glue.menu.register("new",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-background-color.png" alt="btn" title="change background color" width="32" height="32">'),!1);$(t).bind("click",function(t){var e=$(this).data("owner"),n=$(e).css("background-color");t.shiftKey&&!(n=prompt("Enter background color (e.g. #ff0000 or rgb(255, 0, 0))",n))||($.glue.colorpicker.show(n,!1,function(t){$(e).css("background-color",t),$(e).children(".glue-text-input").css("background-color",t)},function(t){$.glue.object.save(e),s=!1}),s=!0)}),$(t).bind("glue-deselect",function(t){s&&($.glue.colorpicker.hide(),s=!1)}),$.glue.contextmenu.register("text","text-background-color",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-background-transparent.png" alt="btn" title="make background transparent" width="32" height="32">'),$(t).bind("click",function(t){var e=$(this).data("owner");$(e).css("background-color","transparent"),$(e).children(".glue-text-input").css("background-color","transparent"),$.glue.object.save(e)}),$.glue.contextmenu.register("text","text-background-transparent",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-font-size.png" alt="btn" title="drag to change font size, click to reset to default one" width="32" height="32">'),$(t).bind("glue-menu-activate",function(t){var e=$(this).data("owner");$(this).attr("title","drag to change font size ("+$(e).css("font-size")+"), click to reset to default one")}),$(t).bind("mousedown",function(t){var s=$(this).data("owner"),i=parseInt($(s).css("font-size")),l=(isNaN(i)&&(i=10),!0),a=this;return $.glue.slider(t,function(t,e){var n=Math.floor(i+e/6);n<0&&(n=0),$(s).css("font-size",n+"px"),$(a).attr("title","drag to change font size ("+n+"px), click to reset to default one"),0==t&&0==e||(l=!1)},function(t,e){l?($(s).css("font-size",""),$.glue.backend({method:"glue.object_remove_attr",name:$(s).attr("id"),attr:"text-font-size"}),$(a).attr("title","drag to change font size ("+$(s).css("font-size")+"px), click to reset to default one")):$.glue.object.save(s)}),!1}),$.glue.contextmenu.register("text","text-font-size",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-font-color.png" alt="btn" title="change font color" width="32" height="32">'),$(t).bind("click",function(t){var e=$(this).data("owner"),n=$(e).css("color");t.shiftKey&&!(n=prompt("Enter font color (e.g. #ff0000 or rgb(255, 0, 0))",n))||($.glue.colorpicker.show(n,!1,function(t){$(e).css("color",t)},function(t){$.glue.object.save(e),s=!1}),s=!0)}),$.glue.contextmenu.register("text","text-font-color",t),t=$('<div class="glue-text-font-family" style="height: 32px; width: 32px;" title="change typeface (click to cycle through available typefaces)">'),$(t).bind("glue-menu-activate",function(t){var e=$(this).data("owner"),n=[],s=($.glue.text.get_fonts([],n),$(e).css("font-family"));for(i=0;i<n.length;i++)if(s===n[i])return $("#glue-contextmenu-text-font-face").addClass("glue-text-font-face"),$("#glue-contextmenu-text-font-face").removeClass("glue-text-font-family"),void $("#glue-contextmenu-text-font-face").attr("title","this is a WOFF web-font ("+s+") - while only supported on the latest browser versions, this text should look similar across different browsers and operating systems supporting WOFF");$("#glue-contextmenu-text-font-face").removeClass("glue-text-font-face"),$("#glue-contextmenu-text-font-face").addClass("glue-text-font-family"),$("#glue-contextmenu-text-font-face").attr("title","change typeface (click to cycle through available typefaces)")}),$(t).bind("click",function(t){for(var e=$(this).data("owner"),n=[],s=[],i=($.glue.text.get_fonts(n,s),$(e).css("font-family")),l=!1,a=0;a<n.length;a++)if(i===n[a]){l=a+1<n.length?a+1:0;break}if(!1!==(l=!1===l&&n.length?0:l)){$(e).css("font-family",n[l]);for(var o=!1,a=0;a<s.length;a++)if(s[a]==n[l]){o=!0;break}o?($(this).addClass("glue-text-font-face"),$(this).removeClass("glue-text-font-family"),$(this).attr("title","this is a WOFF web-font ("+n[l]+") - while only supported on the latest browser versions, this text should look similar across different browsers and operating systems supporting WOFF")):($(this).removeClass("glue-text-font-face"),$(this).addClass("glue-text-font-family"),$(this).attr("title","change typeface (click to cycle through available typefaces)")),$.glue.object.save(e)}}),$.glue.contextmenu.register("text","text-font-face",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-font-style.png" alt="btn" title="change font style" width="32" height="32">'),$(t).bind("click",function(t){var e=$(this).data("owner");"normal"!=$(e).css("font-style")||"bold"!=$(e).css("font-weight")&&"700"!=$(e).css("font-weight")?"italic"!=$(e).css("font-style")||"normal"!=$(e).css("font-weight")&&"400"!=$(e).css("font-weight")?"italic"!=$(e).css("font-style")||"bold"!=$(e).css("font-weight")&&"700"!=$(e).css("font-weight")?($(e).css("font-style","normal"),$(e).css("font-weight","bold")):($(e).css("font-style","normal"),$(e).css("font-weight","normal")):($(e).css("font-style","italic"),$(e).css("font-weight","bold")):($(e).css("font-style","italic"),$(e).css("font-weight","normal")),$.glue.object.save(e)}),$.glue.contextmenu.register("text","text-font-style",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-line-height.png" alt="btn" title="change line height, click to reset to default one" width="32" height="32">'),$(t).bind("glue-menu-activate",function(t){}),$(t).bind("mousedown",function(t){var s,i=$(this).data("owner"),l=parseFloat($(i).css("font-size")),a=(s="em"==$(i).css("line-height").substr(-2)?parseFloat($(i).css("line-height"))*l:"px"==$(i).css("line-height").substr(-2)?parseFloat($(i).css("line-height")):1.2*l,!0);return $.glue.slider(t,function(t,e){var n=s+e/6;n<0&&(n=0),$(i).css("line-height",n/l+"em"),0==t&&0==e||(a=!1)},function(t,e){a?($(i).css("line-height",""),$.glue.backend({method:"glue.object_remove_attr",name:$(i).attr("id"),attr:"text-line-height"})):$.glue.object.save(i)}),!1}),$.glue.contextmenu.register("text","text-line-height",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-letter-spacing.png" alt="btn" title="change letter spacing" width="32" height="32">'),$(t).bind("glue-menu-activate",function(t){}),$(t).bind("mousedown",function(t){var s,i=$(this).data("owner"),l=parseFloat($(i).css("font-size")),a=(s="em"==$(i).css("letter-spacing").substr(-2)?parseFloat($(i).css("letter-spacing"))*l:"px"==$(i).css("letter-spacing").substr(-2)?parseFloat($(i).css("letter-spacing")):0,!0);return $.glue.slider(t,function(t,e){var n=s+e/6;$(i).css("letter-spacing",n/l+"em"),0==t&&0==e||(a=!1)},function(t,e){a?($(i).css("letter-spacing",""),$.glue.backend({method:"glue.object_remove_attr",name:$(i).attr("id"),attr:"text-letter-spacing"})):$.glue.object.save(i)}),!1}),$.glue.contextmenu.register("text","text-letter-spacing",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-word-spacing.png" alt="btn" title="change word spacing" width="32" height="32">'),$(t).bind("glue-menu-activate",function(t){}),$(t).bind("mousedown",function(t){var s,i=$(this).data("owner"),l=parseFloat($(i).css("font-size")),a=(s="em"==$(i).css("word-spacing").substr(-2)?parseFloat($(i).css("word-spacing"))*l:"px"==$(i).css("word-spacing").substr(-2)?parseFloat($(i).css("word-spacing")):0,!0);return $.glue.slider(t,function(t,e){var n=s+e/6;$(i).css("word-spacing",n/l+"em"),0==t&&0==e||(a=!1)},function(t,e){a?($(i).css("word-spacing",""),$.glue.backend({method:"glue.object_remove_attr",name:$(i).attr("id"),attr:"text-word-spacing"})):$.glue.object.save(i)}),!1}),$.glue.contextmenu.register("text","text-word-spacing",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-align.png" alt="btn" title="change text alignment" width="32" height="32">'),$(t).bind("glue-menu-activate",function(t){var e=$(this).data("owner"),e=$(e).css("text-align");"center"==e?$(this).attr("title","change text alignment (center)"):"right"==e?$(this).attr("title","change text alignment (right)"):"justify"==e?$(this).attr("title","change text alignment (justify)"):$(this).attr("title","change text alignment (left)")}),$(t).bind("click",function(t){var e=$(this).data("owner"),n=$(e).css("text-align");"center"==n?($(e).css("text-align","right"),$(this).attr("title","change text alignment (right)")):"right"==n?($(e).css("text-align","justify"),$(this).attr("title","change text alignment (justify)")):"justify"==n?($(e).css("text-align","left"),$(this).attr("title","change text alignment (left)")):($(e).css("text-align","center"),$(this).attr("title","change text alignment (center)")),$.glue.object.save(e)}),$.glue.contextmenu.register("text","text-align",t),t=$('<img src="'+$.glue.base_url+'modules/text/text-padding.png" alt="btn" title="change padding, click to reset to default one" width="32" height="32">'),$(t).bind("glue-menu-activate",function(t){var e=$(this).data("owner");$(this).attr("title","change padding ("+$(e).css("padding-left")+", "+$(e).css("padding-top")+"), click to reset to default one")}),$(t).bind("mousedown",function(t){var l=$(this).data("owner"),a=parseInt($(l).css("padding-left")),o=(isNaN(a)&&(a=0),$(l).width()),r=parseInt($(l).css("padding-top")),c=(isNaN(r)&&(r=0),$(l).height()),g=!0,u=this;return $.glue.slider(t,function(t,e,n){var s=Math.floor(a+t/6),i=(s<0&&(s=0),Math.floor(r+e/6));i<0&&(i=0),n.shiftKey&&(s<i?s=i:i<s&&(i=s)),$(l).css("padding-left",s+"px"),$(l).css("padding-right",s+"px"),$(l).css("width",o+2*a-2*s+"px"),$(l).css("padding-top",i+"px"),$(l).css("padding-bottom",i+"px"),$(l).css("height",c+2*r-2*i+"px"),$(u).attr("title","change padding ("+s+"px, "+i+"px), click to reset to default one"),0==t&&0==e||(g=!1)},function(t,e){var n;g&&(n=parseInt($(l).css("padding-left")),isNaN(n)||$(l).css("width",$(l).width()+2*n+"px"),n=parseInt($(l).css("padding-top")),isNaN(n)||$(l).css("height",$(l).height()+2*n+"px"),$(l).css("padding-left",""),$(l).css("padding-right",""),$(l).css("padding-top",""),$(l).css("padding-bottom",""),$(u).attr("title","change padding ("+$(l).css("padding-left")+", "+$(l).css("padding-top")+"), click to reset to default one")),$.glue.object.save(l)}),!1}),$.glue.contextmenu.register("text","text-text-padding",t),$.glue.object.register_alter_pre_save("text",function(t,e){$(t).children(".glue-text-input").css("background-image",""),$(t).children(".glue-text-input").remove(),$(t).children(".glue-text-render").remove()})});