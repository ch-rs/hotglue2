$.glue.image=function(){var s=!1,g=!1;return{autoresize:function(e,t){void 0===t&&(t="center");var i,a,o,s,g,r,n,u=$.glue.conf.image.upload_resize_larger,c=$.glue.conf.image.upload_resize_to;"0%"==u&&"0%"==c||(i=$(e).width(),a=$(e).height(),o=$(window).width(),s=$(window).height(),u=parseFloat(u),c=parseFloat(c),isNaN(u))||isNaN(c)||(g=!1,n=a,o*u/100<(r=i)&&(n=(r=o*c/100)*a/i,g=!0),s*u/100<a&&s*c/100<n&&(r=(n=s*c/100)*i/a,g=!0),g&&($(e).css("width",r+"px"),$(e).css("height",n+"px"),"center"==t&&($(e).css("left",$(e).position().left+(i-r)/2+"px"),$(e).css("top",$(e).position().top+(a-n)/2+"px")),$.glue.object.resizable_update_tooltip(e),$.glue.image.resize(e,t)))},resize:function(t,i){var a,o;$.glue.conf.image.resizing&&"no-repeat"==$(t).css("background-repeat")&&(void 0===i&&(i="center"),a=$(t).width(),o=$(t).height(),$.glue.backend({method:"image.resize",name:$(t).attr("id"),width:a,height:o},function(e){e?e["#error"]?console.error(e["#data"]):e["#data"]&&(clearTimeout(g),e=$(t).clone(),$(e).attr("id",""),$(e).attr("class","glue-object-copy"),"center"==i&&($(e).css("left",$(t).position().left+($(t).outerWidth()-a)/2+"px"),$(e).css("top",$(t).position().top+($(t).outerHeight()-o)/2+"px")),$(e).css("background-image","url("+$.glue.base_url+"?"+$(t).attr("id")+"&w="+a+"&h="+o+")"),$(t).before(e),$(t).one("glue-movestart",function(){$(".glue-object-copy").remove()}),$(t).one("glue-resizestart",function(){$(".glue-object-copy").remove()}),$(t).one("glue-unregister",function(){$(".glue-object-copy").remove()}),s=e,g=setTimeout(function(){$(t).css("background-image","url("+$.glue.base_url+"?"+$(t).attr("id")+"&w="+a+"&h="+o+")");var e=s;setTimeout(function(){$(e).remove()},500),s=!1},500)):console.error("image.resize returned null")},!1))}}}(),$(".image").live("glue-resizestop",function(e){$.glue.image.resize($(this))}),$(".image").live("glue-upload-dynamic-late",function(e,t){$(t).is("img")&&($(this).css("width",$(t).width()+"px"),$(this).css("height",$(t).height()+"px"),$.glue.backend({method:"glue.update_object",name:$(this).attr("id"),"image-file-width":$(t).width(),"image-file-height":$(t).height()}),$(this).css("background-image","url("+$(t).attr("src")+")"),$(this).css("background-repeat","no-repeat"),$(this).css("background-size","100% 100%"),$(this).css("-moz-background-size","100% 100%"),$(t).remove(),$.glue.image.autoresize(this))}),$(".image").live("glue-upload-static",function(e,t){$.glue.image.autoresize(this,t)}),$(document).ready(function(){$.glue.contextmenu.veto("iframe","object-link");var e=$('<img src="'+$.glue.base_url+'modules/image/image-tile.png" alt="btn" title="toggle image tiling" width="32" height="32">');$(e).bind("click",function(e){var t=$(this).data("owner");"no-repeat"!=$(t).css("background-repeat")?($(t).css("background-repeat","no-repeat"),$(t).css("background-size","100% 100%"),$(t).css("-moz-background-size","100% 100%")):($(t).css("background-repeat","repeat"),$(t).css("background-size",""),$(t).css("-moz-background-size","")),$.glue.object.save(t)}),$.glue.contextmenu.register("image","image-tile",e),e=$('<img src="'+$.glue.base_url+'modules/image/image-ratio.png" alt="btn" title="reset image size" width="32" height="32">'),$(e).bind("click",function(i){var a=$(this).data("owner");$.glue.backend({method:"glue.load_object",name:$(a).attr("id")},function(e){var t;e["image-file-width"]&&e["image-file-height"]&&(t=e["image-file-width"]/e["image-file-height"],$(a).trigger("glue-resizestart"),i.shiftKey?$(a).css("height",$(a).width()/t+"px"):i.ctrlKey?$(a).css("width",$(a).height()*t+"px"):($(a).css("width",e["image-file-width"]+"px"),$(a).css("height",e["image-file-height"]+"px")),$(a).trigger("glue-resize"),$.glue.object.resizable_update_tooltip(a),$.glue.object.save(a),$(a).trigger("glue-resizestop"),$.glue.canvas.update(a))})}),$.glue.contextmenu.register("image","image-ratio",e),e=$('<img src="'+$.glue.base_url+'modules/image/image-pos.png" alt="btn" title="adjust image selection" width="32" height="32">'),$(e).bind("mousedown",function(e){var i,a,o=$(this).data("owner"),t=$(o).css("background-position").split(" "),s=(2!=t.length?a=i=0:(i=parseInt(t[0]),isNaN(i)&&(i=0),a=parseInt(t[1]),isNaN(a)&&(a=0)),!0);return $.glue.slider(e,function(e,t){$(o).css("background-position",i+e+"px "+(a+t)+"px"),0==e&&0==t||(s=!1)},function(e,t){s?($(o).css("background-position",""),$.glue.backend({method:"glue.object_remove_attr",name:$(o).attr("id"),attr:"image-background-position"})):$.glue.object.save(o)}),!1}),$.glue.contextmenu.register("image","image-pos",e),e=$('<img src="'+$.glue.base_url+'img/download.png" alt="btn" title="download original file" width="32" height="32">'),$(e).bind("click",function(e){var t=$(this).data("owner");window.location=$.glue.base_url+"?"+$(t).attr("id")+"&download=1"}),$.glue.contextmenu.register("image","image-download",e)});